<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Azure Security Cost Analyzer</title>
    <script src="https://cdn.jsdelivr.net/npm/react@17/umd/react.development.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/react-dom@17/umd/react-dom.development.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.7.1/dist/chart.min.js"></script>
    <script src="https://alcdn.msauth.net/browser/2.30.0/js/msal-browser.min.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
</head>

<body>
    <div id="root"></div>
    <script type="text/babel">
        const { useState, useEffect, Component } = React;

        // MSAL Configuration
        const msalConfig = {
            auth: {
                clientId: "<your-client-id>", // Replace with your app registration's Client ID
                authority: "https://login.microsoftonline.com/e7ea7b4d-a56f-426b-be45-857324a57837",
                redirectUri: "https://<random-name>.azurestaticapps.net", // Replace with your Static Web App URL
            },
            cache: {
                cacheLocation: "sessionStorage",
                storeAuthStateInCookie: false,
            },
        };

        const msalInstance = new msal.PublicClientApplication(msalConfig);

        const login = async () => {
            try {
                const loginResponse = await msalInstance.loginPopup({
                    scopes: ["User.Read", "access_as_user"],
                });
                console.log("Login successful", loginResponse);
                return loginResponse.accessToken;
            } catch (error) {
                console.error("Login failed", error);
                throw error;
            }
        };

        const getToken = async () => {
            const accounts = msalInstance.getAllAccounts();
            if (accounts.length > 0) {
                try {
                    const tokenResponse = await msalInstance.acquireTokenSilent({
                        scopes: ["access_as_user"],
                        account: accounts[0],
                    });
                    return tokenResponse.accessToken;
                } catch (error) {
                    console.error("Silent token acquisition failed", error);
                    return await login();
                }
            } else {
                return await login();
            }
        };

        class ErrorBoundary extends Component {
            state = { hasError: false, error: null };

            static getDerivedStateFromError(error) {
                return { hasError: true, error };
            }

            render() {
                if (this.state.hasError) {
                    return (
                        <div className="p-6 bg-red-100 text-red-700 rounded-md m-6">
                            <h2 className="text-xl font-semibold">Something went wrong.</h2>
                            <p>{this.state.error?.message || "An unexpected error occurred."}</p>
                            <p>Check the console for details and try refreshing the page.</p>
                        </div>
                    );
                }
                return this.props.children;
            }
        }

        const App = () => {
            const [subscriptionFilter, setSubscriptionFilter] = useState("");
            const [selectedSubscriptions, setSelectedSubscriptions] = useState([]);
            const [selectedService, setSelectedService] = useState("StorageAccounts");
            const [startDate, setStartDate] = useState(
                new Date(Date.now() - 30 * 24 * 60 * 60 * 1000).toISOString().split("T")[0]
            );
            const [endDate, setEndDate] = useState(new Date().toISOString().split("T")[0]);
            const [costData, setCostData] = useState(null);
            const [loading, setLoading] = useState(false);
            const [error, setError] = useState("");
            const [activeTab, setActiveTab] = useState("Overview");
            const [selectedRange, setSelectedRange] = useState("Last 30 Days");

            const services = [
                'Arm',
                'OpenSourceRelationalDatabases',
                'Dns',
                'KeyVaults',
                'CosmosDB',
                'Containers',
                'VirtualMachines',
                'SqlServers',
                'StorageAccounts',
                'AppServices'
            ];
            const months = ["Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"];
            const daysOfWeek = ["Sun", "Mon", "Tue", "Wed", "Thu", "Fri", "Sat"];

            const fetchCosts = async () => {
                try {
                    setError("");
                    if (new Date(startDate) > new Date(endDate)) {
                        setError("Start date must be before end date.");
                        return;
                    }
                    setLoading(true);

                    const token = await getToken();

                    // Fetch cost data
                    const costResponse = await fetch('https://cost-analyzer-app.azurewebsites.net/api/costs', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${token}`,
                        },
                        body: JSON.stringify({
                            startDate: new Date(startDate).toISOString(),
                            endDate: new Date(endDate).toISOString(),
                        }),
                    });

                    const costData = await costResponse.json();
                    if (!costResponse.ok) {
                        throw new Error(costData.error || 'Failed to fetch cost data');
                    }

                    // Fetch top resources
                    const resourceResponse = await fetch('https://cost-analyzer-app.azurewebsites.net/api/top-resources', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${token}`,
                        },
                        body: JSON.stringify({
                            startDate: new Date(startDate).toISOString(),
                            endDate: new Date(endDate).toISOString(),
                        }),
                    });

                    const topResources = await resourceResponse.json();
                    if (!resourceResponse.ok) {
                        throw new Error(topResources.error || 'Failed to fetch top resources');
                    }

                    // Fetch Defender plans
                    const plansResponse = await fetch('https://cost-analyzer-app.azurewebsites.net/api/plans', {
                        method: 'GET',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${token}`,
                        },
                    });

                    const plans = await plansResponse.json();
                    if (!plansResponse.ok) {
                        throw new Error(plans.error || 'Failed to fetch Defender plans');
                    }

                    const rows = costData.properties?.rows || [];
                    const subscriptions = costData.subscriptions || [];
                    const transformedData = {
                        overallCost: 0,
                        monthlyCost: 0,
                        avgDailyCost: 0,
                        subscriptions,
                        subscriptionCosts: [],
                        services: {
                            Arm: { costs: [], plans: [], topResources: [] },
                            OpenSourceRelationalDatabases: { costs: [], plans: [], topResources: [] },
                            Dns: { costs: [], plans: [], topResources: [] },
                            KeyVaults: { costs: [], plans: [], topResources: [] },
                            CosmosDB: { costs: [], plans: [], topResources: [] },
                            Containers: { costs: [], plans: [], topResources: [] },
                            VirtualMachines: { costs: [], plans: [], topResources: [] },
                            SqlServers: { costs: [], plans: [], topResources: [] },
                            StorageAccounts: { costs: [], plans: [], topResources: [] },
                            AppServices: { costs: [], plans: [], topResources: [] },
                        },
                    };

                    const dateDiff = (new Date(endDate) - new Date(startDate)) / (1000 * 60 * 60 * 24) + 1;

                    const subscriptionCostMap = {};
                    rows.forEach((row) => {
                        const [cost, meterCategory, planName, subscriptionId, resourceGroup, subscriptionName] = row;
                        transformedData.overallCost += cost;

                        if (subscriptionId) {
                            subscriptionCostMap[subscriptionId] = (subscriptionCostMap[subscriptionId] || 0) + cost;
                        }

                        const billingMonth = new Date(startDate).toISOString().slice(0, 7);
                        const month = months[parseInt(billingMonth.slice(5, 7), 10) - 1] || 'Unknown';

                        if (transformedData.services[planName]) {
                            transformedData.services[planName].costs.push({
                                subscriptionId,
                                subscriptionName,
                                meterSubCategory: planName,
                                cost,
                                month,
                                resourceGroup: resourceGroup || "Unknown",
                            });
                        }
                    });

                    transformedData.subscriptionCosts = Object.entries(subscriptionCostMap).map(([subscriptionId, totalCost]) => {
                        const sub = subscriptions.find(s => s.subscriptionId === subscriptionId);
                        return {
                            subscriptionId,
                            subscriptionName: sub?.displayName || `Subscription ${subscriptionId.slice(0, 8)}`,
                            totalCost,
                        };
                    });

                    transformedData.monthlyCost = transformedData.overallCost / (dateDiff / 30);
                    transformedData.avgDailyCost = transformedData.overallCost / dateDiff;

                    // Map Defender plans to services
                    const planToServiceMap = {
                        'Arm': 'Arm',
                        'Databases': 'OpenSourceRelationalDatabases',
                        'OpenSourceRelationalDatabases': 'OpenSourceRelationalDatabases',
                        'DNS': 'Dns',
                        'Dns': 'Dns',
                        'KeyVault': 'KeyVaults',
                        'KeyVaults': 'KeyVaults',
                        'CosmosDbs': 'CosmosDB',
                        'CosmosDB': 'CosmosDB',
                        'Containers': 'Containers',
                        'Servers': 'VirtualMachines',
                        'VirtualMachines': 'VirtualMachines',
                        'SqlServers': 'SqlServers',
                        'StorageAccounts': 'StorageAccounts',
                        'AppServices': 'AppServices',
                        'AppService': 'AppServices',
                    };
                    subscriptions.forEach((sub) => {
                        services.forEach((service) => {
                            const plan = plans.find(p => p.subscriptionId === sub.subscriptionId && planToServiceMap[p.planName] === service);
                            if (!plan) {
                                console.log(`No plan found for subscription ${sub.subscriptionId}, service ${service}`);
                            }
                            transformedData.services[service].plans.push({
                                subscriptionId: sub.subscriptionId,
                                planName: service,
                                tier: plan ? plan.pricingTier : 'Free',
                            });
                        });
                    });

                    // Map top resources to their respective services
                    const resourceToServiceMap = {
                        'Azure ARM service layers': 'Arm',
                        'Azure Database for MySQL': 'OpenSourceRelationalDatabases',
                        'Azure Database for PostgreSQL': 'OpenSourceRelationalDatabases',
                        'Azure DNS service layers': 'Dns',
                        'Key Vault': 'KeyVaults',
                        'Microsoft Defender for Azure Cosmos DB': 'CosmosDB',
                        'Microsoft Defender for Containers': 'Containers',
                        'Servers': 'VirtualMachines',
                        'SQL Database': 'SqlServers',
                        'Storage': 'StorageAccounts',
                        'Workload Protection for App Services': 'AppServices',
                    };
                    topResources.forEach(resource => {
                        const service = resourceToServiceMap[resource.meterSubCategory] || resource.meterSubCategory;
                        if (transformedData.services[service]) {
                            transformedData.services[service].topResources.push({
                                subscriptionId: resource.subscriptionId,
                                subscriptionName: resource.subscriptionName,
                                resourceName: resource.resourceName,
                                resourceId: resource.resourceId,
                                meterSubCategory: resource.meterSubCategory,
                                cost: resource.cost,
                            });
                        }
                    });

                    setCostData(transformedData);
                    console.log('Cost data set:', transformedData);
                    setSelectedSubscriptions(subscriptions.map(s => s.subscriptionId));
                    setLoading(false);
                } catch (err) {
                    console.error("Error in fetchCosts:", err);
                    setError(`Failed to fetch cost data: ${err.message}. Check the console for details.`);
                    setLoading(false);
                }
            };

            const setDateRange = (range) => {
                const today = new Date();
                let newStartDate;
                switch (range) {
                    case "Last 7 Days":
                        newStartDate = new Date(today.getTime() - 7 * 24 * 60 * 60 * 1000);
                        break;
                    case "Last 30 Days":
                        newStartDate = new Date(today.getTime() - 30 * 24 * 60 * 60 * 1000);
                        break;
                    case "Last Year":
                        newStartDate = new Date(today.getTime() - 365 * 24 * 60 * 60 * 1000);
                        break;
                    default:
                        newStartDate = new Date(today.getTime() - 30 * 24 * 60 * 60 * 1000);
                }
                setStartDate(newStartDate.toISOString().split("T")[0]);
                setEndDate(today.toISOString().split("T")[0]);
                setSelectedRange(range);
            };

            const exportToCsv = () => {
                try {
                    if (!costData) {
                        setError("No data to export.");
                        return;
                    }
                    const headers = ["Section", "Subscription", "Service", "Plan", "Meter Subcategory", "Resource", "Cost (€)"];
                    const rows = [];

                    rows.push(["Overall Cost", "", "", "", "", "", costData.overallCost.toFixed(2)]);
                    costData.subscriptionCosts.forEach((sub) => {
                        rows.push(["Subscription Costs", sub.subscriptionName, "", "", "", "", sub.totalCost.toFixed(2)]);
                    });

                    Object.keys(costData.services).forEach((service) => {
                        const serviceData = costData.services[service];
                        serviceData.costs.forEach((item) => {
                            rows.push(["Service Costs", item.subscriptionName, service, "", item.meterSubCategory, "", item.cost.toFixed(2)]);
                        });
                        serviceData.plans.forEach((plan) => {
                            const sub = costData.subscriptions.find((s) => s.subscriptionId === plan.subscriptionId);
                            rows.push(["Service Plans", sub?.displayName || "Unknown", service, plan.tier, "", "", ""]);
                        });
                        if (serviceData.topResources) {
                            serviceData.topResources.forEach((resource) => {
                                const sub = costData.subscriptions.find((s) => s.subscriptionId === resource.subscriptionId);
                                rows.push([
                                    "Top Resources",
                                    sub?.displayName || "Unknown",
                                    service,
                                    "",
                                    resource.meterSubCategory,
                                    resource.resourceName,
                                    resource.cost.toFixed(2),
                                ]);
                            });
                        }
                    });

                    const csvContent = [headers, ...rows].map((row) => row.join(",")).join("\n");
                    const blob = new Blob([csvContent], { type: "text/csv;charset=utf-8;" });
                    const link = document.createElement("a");
                    link.href = URL.createObjectURL(blob);
                    link.download = `security_costs_detailed.csv`;
                    link.click();
                } catch (err) {
                    console.error("Error in exportToCsv:", err);
                    setError("Failed to export data. Check the console for details.");
                }
            };

            useEffect(() => {
                fetchCosts();
            }, []);

            useEffect(() => {
                if (costData) {
                    const monthlyData = months.map((month) => {
                        return Object.values(costData.services).reduce((sum, service) => {
                            const monthCost = service.costs
                                .filter((item) => item.month === month && selectedSubscriptions.includes(item.subscriptionId))
                                .reduce((total, item) => total + item.cost, 0);
                            return sum + monthCost;
                        }, 0);
                    });

                    const monthlyBarCtx = document.getElementById("monthlyBarChart")?.getContext("2d");
                    if (monthlyBarCtx) {
                        if (window.monthlyBarChart && typeof window.monthlyBarChart.destroy === "function") {
                            window.monthlyBarChart.destroy();
                        }
                        window.monthlyBarChart = new Chart(monthlyBarCtx, {
                            type: "bar",
                            data: {
                                labels: months,
                                datasets: [
                                    {
                                        label: "Monthly Cost (€)",
                                        data: monthlyData,
                                        backgroundColor: "rgba(59, 130, 246, 0.5)",
                                        borderColor: "rgba(59, 130, 246, 1)",
                                        borderWidth: 1,
                                    },
                                ],
                            },
                            options: {
                                scales: {
                                    y: { beginAtZero: true },
                                },
                                plugins: {
                                    legend: { display: false },
                                    title: { display: true, text: "Monthly Security Cost" },
                                },
                            },
                        });
                    }

                    const servicePieCtx = document.getElementById("servicePieChart")?.getContext("2d");
                    if (servicePieCtx) {
                        if (window.servicePieChart && typeof window.servicePieChart.destroy === "function") {
                            window.servicePieChart.destroy();
                        }
                        const serviceData = services.map((service) => {
                            return costData.services[service].costs
                                .filter((item) => selectedSubscriptions.includes(item.subscriptionId))
                                .reduce((total, item) => total + item.cost, 0);
                        });
                        window.servicePieChart = new Chart(servicePieCtx, {
                            type: "pie",
                            data: {
                                labels: services,
                                datasets: [
                                    {
                                        data: serviceData,
                                        backgroundColor: [
                                            "rgba(59, 130, 246, 0.5)",
                                            "rgba(255, 99, 132, 0.5)",
                                            "rgba(54, 162, 235, 0.5)",
                                            "rgba(255, 206, 86, 0.5)",
                                            "rgba(75, 192, 192, 0.5)",
                                            "rgba(153, 102, 255, 0.5)",
                                            "rgba(255, 159, 64, 0.5)",
                                            "rgba(199, 199, 199, 0.5)",
                                            "rgba(83, 83, 83, 0.5)",
                                            "rgba(255, 99, 71, 0.5)",
                                        ],
                                        borderColor: [
                                            "rgba(59, 130, 246, 1)",
                                            "rgba(255, 99, 132, 1)",
                                            "rgba(54, 162, 235, 1)",
                                            "rgba(255, 206, 86, 1)",
                                            "rgba(75, 192, 192, 1)",
                                            "rgba(153, 102, 255, 1)",
                                            "rgba(255, 159, 64, 1)",
                                            "rgba(199, 199, 199, 1)",
                                            "rgba(83, 83, 83, 1)",
                                            "rgba(255, 99, 71, 1)",
                                        ],
                                        borderWidth: 1,
                                    },
                                ],
                            },
                            options: {
                                plugins: {
                                    legend: { position: "right" },
                                    title: { display: true, text: "Cost by Service" },
                                },
                            },
                        });
                    }

                    const varianceBarCtx = document.getElementById("varianceBarChart")?.getContext("2d");
                    if (varianceBarCtx) {
                        if (window.varianceBarChart && typeof window.varianceBarChart.destroy === "function") {
                            window.varianceBarChart.destroy();
                        }
                        const varianceData = monthlyData.map((current, idx) => {
                            const previous = idx === 0 ? 0 : monthlyData[idx - 1];
                            return current - previous;
                        });
                        window.varianceBarChart = new Chart(varianceBarCtx, {
                            type: "bar",
                            data: {
                                labels: months,
                                datasets: [
                                    {
                                        label: "Increase",
                                        data: varianceData.map((val) => (val > 0 ? val : 0)),
                                        backgroundColor: "rgba(255, 99, 132, 0.5)",
                                        borderColor: "rgba(255, 99, 132, 1)",
                                        borderWidth: 1,
                                    },
                                    {
                                        label: "Decrease",
                                        data: varianceData.map((val) => (val < 0 ? Math.abs(val) : 0)),
                                        backgroundColor: "rgba(54, 162, 235, 0.5)",
                                        borderColor: "rgba(54, 162, 235, 1)",
                                        borderWidth: 1,
                                    },
                                ],
                            },
                            options: {
                                scales: {
                                    y: { beginAtZero: true },
                                },
                                plugins: {
                                    legend: { display: true },
                                    title: { display: true, text: "Monthly Cost Variance" },
                                },
                            },
                        });
                    }

                    const rgPieCtx = document.getElementById("rgPieChart")?.getContext("2d");
                    if (rgPieCtx) {
                        if (window.rgPieChart && typeof window.rgPieChart.destroy === "function") {
                            window.rgPieChart.destroy();
                        }
                        const resourceGroups = Array.from(
                            new Set(
                                Object.values(costData.services)
                                    .flatMap((service) => service.costs)
                                    .filter((item) => selectedSubscriptions.includes(item.subscriptionId))
                                    .map((item) => item.resourceGroup)
                                    .filter((rg) => rg)
                            )
                        );
                        const rgData = resourceGroups.map((rg) => {
                            return Object.values(costData.services).reduce((sum, service) => {
                                const rgCost = service.costs
                                    .filter((item) => item.resourceGroup === rg && selectedSubscriptions.includes(item.subscriptionId))
                                    .reduce((total, item) => total + item.cost, 0);
                                return sum + rgCost;
                            }, 0);
                        });
                        window.rgPieChart = new Chart(rgPieCtx, {
                            type: "pie",
                            data: {
                                labels: resourceGroups,
                                datasets: [
                                    {
                                        data: rgData,
                                        backgroundColor: ["rgba(59, 130, 246, 0.5)", "rgba(255, 99, 132, 0.5)"],
                                        borderColor: ["rgba(59, 130, 246, 1)", "rgba(255, 99, 132, 1)"],
                                        borderWidth: 1,
                                    },
                                ],
                            },
                            options: {
                                plugins: {
                                    legend: { position: "right" },
                                    title: { display: true, text: "Cost by Resource Group" },
                                },
                            },
                        });
                    }

                    const dowBarCtx = document.getElementById("dowBarChart")?.getContext("2d");
                    if (dowBarCtx) {
                        if (window.dowBarChart && typeof window.dowBarChart.destroy === "function") {
                            window.dowBarChart.destroy();
                        }
                        const dowData = daysOfWeek.map((day, idx) => {
                            return Object.values(costData.services).reduce((sum, service) => {
                                const dayCost = service.costs
                                    .filter((item) => selectedSubscriptions.includes(item.subscriptionId))
                                    .reduce((total, item) => total + item.cost / 30, 0);
                                return sum + dayCost;
                            }, 0);
                        });
                        window.dowBarChart = new Chart(dowBarCtx, {
                            type: "bar",
                            data: {
                                labels: daysOfWeek,
                                datasets: [
                                    {
                                        label: "Avg Daily Cost (€)",
                                        data: dowData,
                                        backgroundColor: "rgba(255, 159, 64, 0.5)",
                                        borderColor: "rgba(255, 159, 64, 1)",
                                        borderWidth: 1,
                                    },
                                ],
                            },
                            options: {
                                scales: {
                                    y: { beginAtZero: true },
                                },
                                plugins: {
                                    legend: { display: false },
                                    title: { display: true, text: "Cost by Day of Week" },
                                },
                            },
                        });
                    }
                }

                return () => {
                    ["monthlyBarChart", "servicePieChart", "varianceBarChart", "rgPieChart", "dowBarChart"].forEach(
                        (chart) => {
                            if (window[chart] && typeof window[chart].destroy === "function") {
                                window[chart].destroy();
                                window[chart] = null;
                            }
                        }
                    );
                };
            }, [costData, selectedSubscriptions]);

            const filteredSubscriptions = subscriptionFilter
                ? costData?.subscriptionCosts.filter((sub) =>
                    sub.subscriptionName.toLowerCase().includes(subscriptionFilter.toLowerCase())
                ) || []
                : costData?.subscriptionCosts || [];

            return (
                <div className="container mx-auto p-6 bg-gray-50 min-h-screen">
                    <header className="mb-6">
                        <h1 className="text-3xl font-bold text-gray-800">Azure Security Cost Analyzer</h1>
                        <p className="text-gray-600 mt-1">
                            Modern dashboard for Azure security cost insights
                            {costData && (
                                <span> | Total Subscriptions: {costData.subscriptions.length}</span>
                            )}
                        </p>
                    </header>

                    <div className="bg-white p-6 rounded-lg shadow-md mb-6">
                        <h2 className="text-xl font-semibold mb-4 text-gray-800">Filters</h2>
                        {error && (
                            <div className="mb-4 p-3 bg-red-100 text-red-700 rounded-md" role="alert">
                                {error}
                            </div>
                        )}
                        <div className="mb-4">
                            <label className="block text-sm font-medium text-gray-700 mb-2">Quick Date Ranges</label>
                            <div className="flex space-x-2">
                                {["Last 7 Days", "Last 30 Days", "Last Year"].map((range) => (
                                    <button
                                        key={range}
                                        onClick={() => setDateRange(range)}
                                        className={`px-4 py-2 rounded-md text-sm font-medium focus:outline-none focus:ring-2 focus:ring-blue-500 ${selectedRange === range
                                            ? "bg-blue-600 text-white"
                                            : "bg-gray-200 text-gray-700 hover:bg-gray-300"
                                            }`}
                                        aria-label={`Select ${range} date range`}
                                    >
                                        {range}
                                    </button>
                                ))}
                            </div>
                        </div>
                        <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                            <div>
                                <label htmlFor="service" className="block text-sm font-medium text-gray-700">
                                    Security Service
                                </label>
                                <select
                                    id="service"
                                    value={selectedService}
                                    onChange={(e) => setSelectedService(e.target.value)}
                                    className="mt-1 block w-full border-gray-300 rounded-md shadow-sm p-2 focus:ring-blue-500 focus:border-blue-500"
                                    aria-label="Select security service"
                                >
                                    {services.map((s) => (
                                        <option key={s} value={s}>
                                            {s}
                                        </option>
                                    ))}
                                </select>
                            </div>
                            <div>
                                <label htmlFor="startDate" className="block text-sm font-medium text-gray-700">
                                    Start Date
                                </label>
                                <input
                                    id="startDate"
                                    type="date"
                                    value={startDate}
                                    onChange={(e) => {
                                        setStartDate(e.target.value);
                                        setSelectedRange("Custom");
                                    }}
                                    className="mt-1 block w-full border-gray-300 rounded-md shadow-sm p-2 focus:ring-blue-500 focus:border-blue-500"
                                    aria-required="true"
                                />
                            </div>
                            <div>
                                <label htmlFor="endDate" className="block text-sm font-medium text-gray-700">
                                    End Date
                                </label>
                                <input
                                    id="endDate"
                                    type="date"
                                    value={endDate}
                                    onChange={(e) => {
                                        setEndDate(e.target.value);
                                        setSelectedRange("Custom");
                                    }}
                                    className="mt-1 block w-full border-gray-300 rounded-md shadow-sm p-2 focus:ring-blue-500 focus:border-blue-500"
                                    aria-required="true"
                                />
                            </div>
                        </div>
                        <div className="mt-4">
                            <label className="block text-sm font-medium text-gray-700 mb-2">Subscriptions</label>
                            <div className="flex flex-wrap gap-2">
                                {costData?.subscriptions.map((sub) => (
                                    <label key={sub.subscriptionId} className="inline-flex items-center">
                                        <input
                                            type="checkbox"
                                            checked={selectedSubscriptions.includes(sub.subscriptionId)}
                                            onChange={(e) => {
                                                const newSelected = e.target.checked
                                                    ? [...selectedSubscriptions, sub.subscriptionId]
                                                    : selectedSubscriptions.filter((id) => id !== sub.subscriptionId);
                                                setSelectedSubscriptions(newSelected);
                                                console.log('Selected subscriptions:', newSelected);
                                            }}
                                            className="h-4 w-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500"
                                        />
                                        <span className="ml-2 text-sm text-gray-700">{sub.displayName}</span>
                                    </label>
                                ))}
                            </div>
                        </div>
                        <div className="mt-4 flex space-x-3">
                            <button
                                onClick={fetchCosts}
                                className={`bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 ${loading ? "opacity-50 cursor-not-allowed" : ""
                                    }`}
                                disabled={loading}
                                aria-label="Apply filters to refresh cost data"
                            >
                                {loading ? "Loading..." : "Apply Filters"}
                            </button>
                            {costData && (
                                <button
                                    onClick={exportToCsv}
                                    className="bg-green-600 text-white px-4 py-2 rounded-md hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-green-500"
                                    aria-label="Export detailed data to CSV"
                                >
                                    Export CSV
                                </button>
                            )}
                        </div>
                    </div>

                    {costData && (
                        <div className="space-y-6">
                            <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                                <div className="bg-white p-4 rounded-lg shadow-md">
                                    <h3 className="text-lg font-semibold text-gray-800">YTD Security Cost</h3>
                                    <p className="text-3xl font-bold text-blue-600">€{costData.overallCost.toFixed(2)}</p>
                                    <p className="text-sm text-gray-500">
                                        Last Year: €{(costData.overallCost * 0.9).toFixed(2)}
                                    </p>
                                </div>
                                <div className="bg-white p-4 rounded-lg shadow-md">
                                    <h3 className="text-lg font-semibold text-gray-800">Monthly Security Cost</h3>
                                    <p className="text-3xl font-bold text-blue-600">€{costData.monthlyCost.toFixed(2)}</p>
                                    <p className="text-sm text-gray-500">
                                        Last Month: €{(costData.monthlyCost * 1.1).toFixed(2)}
                                    </p>
                                </div>
                                <div className="bg-white p-4 rounded-lg shadow-md">
                                    <h3 className="text-lg font-semibold text-gray-800">Avg Daily Cost</h3>
                                    <p className="text-3xl font-bold text-blue-600">€{costData.avgDailyCost.toFixed(2)}</p>
                                    <p className="text-sm text-gray-500">
                                        Last Month: €{(costData.avgDailyCost * 0.95).toFixed(2)}
                                    </p>
                                </div>
                            </div>

                            <div className="bg-white rounded-lg shadow-md">
                                <div className="flex border-b">
                                    {["Overview", "Subscriptions", "Services", "Resource Groups"].map((tab) => (
                                        <button
                                            key={tab}
                                            onClick={() => setActiveTab(tab)}
                                            className={`px-4 py-2 font-medium text-sm focus:outline-none ${activeTab === tab
                                                ? "border-b-2 border-blue-600 text-blue-600"
                                                : "text-gray-600 hover:text-blue-600"
                                                }`}
                                        >
                                            {tab}
                                        </button>
                                    ))}
                                </div>

                                <div className="p-4">
                                    {activeTab === "Overview" && (
                                        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                                            <div className="bg-white p-4 rounded-lg shadow-sm">
                                                <canvas
                                                    id="monthlyBarChart"
                                                    className="max-h-80"
                                                    role="img"
                                                    aria-label="Bar chart showing monthly security costs"
                                                ></canvas>
                                            </div>
                                            <div className="bg-white p-4 rounded-lg shadow-sm">
                                                <canvas
                                                    id="servicePieChart"
                                                    className="max-h-80"
                                                    role="img"
                                                    aria-label="Pie chart showing cost by service"
                                                ></canvas>
                                            </div>
                                            <div className="bg-white p-4 rounded-lg shadow-sm">
                                                <canvas
                                                    id="varianceBarChart"
                                                    className="max-h-80"
                                                    role="img"
                                                    aria-label="Bar chart showing monthly cost variance"
                                                ></canvas>
                                            </div>
                                            <div className="bg-white p-4 rounded-lg shadow-sm">
                                                <canvas
                                                    id="rgPieChart"
                                                    className="max-h-80"
                                                    role="img"
                                                    aria-label="Pie chart showing cost by resource group"
                                                ></canvas>
                                            </div>
                                            <div className="bg-white p-4 rounded-lg shadow-sm">
                                                <canvas
                                                    id="dowBarChart"
                                                    className="max-h-80"
                                                    role="img"
                                                    aria-label="Bar chart showing cost by day of week"
                                                ></canvas>
                                            </div>
                                        </div>
                                    )}

                                    {activeTab === "Subscriptions" && (
                                        <div className="bg-white p-4 rounded-lg shadow-sm">
                                            <h3 className="text-lg font-semibold mb-4 text-gray-800">Costs by Subscription</h3>
                                            <div className="mb-4">
                                                <label htmlFor="subscriptionFilter" className="block text-sm font-medium text-gray-700">
                                                    Filter Subscriptions
                                                </label>
                                                <input
                                                    id="subscriptionFilter"
                                                    type="text"
                                                    value={subscriptionFilter}
                                                    onChange={(e) => setSubscriptionFilter(e.target.value)}
                                                    className="mt-1 block w-full md:w-1/3 border-gray-300 rounded-md shadow-sm p-2 focus:ring-blue-500 focus:border-blue-500"
                                                    placeholder="Filter by subscription name"
                                                    aria-label="Filter subscriptions by name"
                                                />
                                            </div>
                                            <div className="overflow-x-auto">
                                                <table className="min-w-full divide-y divide-gray-200">
                                                    <thead className="bg-gray-50">
                                                        <tr>
                                                            <th
                                                                scope="col"
                                                                className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"
                                                            >
                                                                Subscription
                                                            </th>
                                                            <th
                                                                scope="col"
                                                                className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"
                                                            >
                                                                Total Cost (€)
                                                            </th>
                                                        </tr>
                                                    </thead>
                                                    <tbody className="bg-white divide-y divide-gray-200">
                                                        {filteredSubscriptions.map((sub) => (
                                                            <tr key={sub.subscriptionId}>
                                                                <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                                                                    {sub.subscriptionName}
                                                                </td>
                                                                <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                                                                    €{sub.totalCost.toFixed(2)}
                                                                </td>
                                                            </tr>
                                                        ))}
                                                    </tbody>
                                                </table>
                                            </div>
                                        </div>
                                    )}

                                    {activeTab === "Services" && (
                                        <div className="space-y-4">
                                            {Object.keys(costData.services).map((service) => (
                                                <div key={service} className="bg-white p-4 rounded-lg shadow-sm">
                                                    <h3 className="text-lg font-semibold mb-4 text-gray-800">Costs for {service}</h3>
                                                    <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                                        <div>
                                                            <h4 className="text-md font-medium mb-2">Cost by Subcategory</h4>
                                                            <div className="overflow-x-auto">
                                                                <table className="min-w-full divide-y divide-gray-200">
                                                                    <thead className="bg-gray-50">
                                                                        <tr>
                                                                            <th
                                                                                scope="col"
                                                                                className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"
                                                                            >
                                                                                Subscription
                                                                            </th>
                                                                            <th
                                                                                scope="col"
                                                                                className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"
                                                                            >
                                                                                Meter Subcategory
                                                                            </th>
                                                                            <th
                                                                                scope="col"
                                                                                className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"
                                                                            >
                                                                                Cost (€)
                                                                            </th>
                                                                        </tr>
                                                                    </thead>
                                                                    <tbody className="bg-white divide-y divide-gray-200">
                                                                        {costData.services[service].costs
                                                                            .filter((item) => selectedSubscriptions.includes(item.subscriptionId))
                                                                            .map((item) => (
                                                                                <tr key={`${item.subscriptionId}-${item.meterSubCategory}`}>
                                                                                    <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                                                                                        {item.subscriptionName}
                                                                                    </td>
                                                                                    <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                                                                                        {item.meterSubCategory}
                                                                                    </td>
                                                                                    <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                                                                                        €{item.cost.toFixed(2)}
                                                                                    </td>
                                                                                </tr>
                                                                            ))}
                                                                    </tbody>
                                                                </table>
                                                            </div>
                                                        </div>
                                                        <div>
                                                            <h4 className="text-md font-medium mb-2">Plan Types</h4>
                                                            <div className="overflow-x-auto">
                                                                <table className="min-w-full divide-y divide-gray-200">
                                                                    <thead className="bg-gray-50">
                                                                        <tr>
                                                                            <th
                                                                                scope="col"
                                                                                className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"
                                                                            >
                                                                                Subscription
                                                                            </th>
                                                                            <th
                                                                                scope="col"
                                                                                className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"
                                                                            >
                                                                                Plan Name
                                                                            </th>
                                                                            <th
                                                                                scope="col"
                                                                                className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"
                                                                            >
                                                                                Tier
                                                                            </th>
                                                                        </tr>
                                                                    </thead>
                                                                    <tbody className="bg-white divide-y divide-gray-200">
                                                                        {costData.services[service].plans
                                                                            .filter((plan) => selectedSubscriptions.includes(plan.subscriptionId))
                                                                            .map((plan) => (
                                                                                <tr key={`${plan.subscriptionId}-${plan.planName}`}>
                                                                                    <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                                                                                        {costData.subscriptions.find((s) => s.subscriptionId === plan.subscriptionId)?.displayName || "Unknown"}
                                                                                    </td>
                                                                                    <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                                                                                        {plan.planName}
                                                                                    </td>
                                                                                    <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                                                                                        {plan.tier}
                                                                                    </td>
                                                                                </tr>
                                                                            ))}
                                                                    </tbody>
                                                                </table>
                                                            </div>
                                                        </div>
                                                    </div>
                                                    {costData.services[service].topResources.length > 0 && (
                                                        <div className="mt-4">
                                                            <h4 className="text-md font-medium mb-2">Top 10 Resources</h4>
                                                            <div className="overflow-x-auto">
                                                                <table className="min-w-full divide-y divide-gray-200">
                                                                    <thead className="bg-gray-50">
                                                                        <tr>
                                                                            <th
                                                                                scope="col"
                                                                                className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"
                                                                            >
                                                                                Subscription
                                                                            </th>
                                                                            <th
                                                                                scope="col"
                                                                                className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"
                                                                            >
                                                                                Resource Name
                                                                            </th>
                                                                            <th
                                                                                scope="col"
                                                                                className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"
                                                                            >
                                                                                Meter Subcategory
                                                                            </th>
                                                                            <th
                                                                                scope="col"
                                                                                className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"
                                                                            >
                                                                                Cost (€)
                                                                            </th>
                                                                        </tr>
                                                                    </thead>
                                                                    <tbody className="bg-white divide-y divide-gray-200">
                                                                        {costData.services[service].topResources
                                                                            .filter((resource) => selectedSubscriptions.includes(resource.subscriptionId))
                                                                            .map((resource) => (
                                                                                <tr key={`${resource.subscriptionId}-${resource.resourceId}`}>
                                                                                    <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                                                                                        {costData.subscriptions.find((s) => s.subscriptionId === resource.subscriptionId)?.displayName || "Unknown"}
                                                                                    </td>
                                                                                    <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                                                                                        {resource.resourceName}
                                                                                    </td>
                                                                                    <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                                                                                        {resource.meterSubCategory}
                                                                                    </td>
                                                                                    <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                                                                                        €{resource.cost.toFixed(2)}
                                                                                    </td>
                                                                                </tr>
                                                                            ))}
                                                                    </tbody>
                                                                </table>
                                                            </div>
                                                        </div>
                                                    )}
                                                </div>
                                            ))}
                                        </div>
                                    )}

                                    {activeTab === "Resource Groups" && (
                                        <div className="bg-white p-4 rounded-lg shadow-sm">
                                            <h3 className="text-lg font-semibold mb-4 text-gray-800">Costs by Resource Group</h3>
                                            <div className="overflow-x-auto">
                                                <table className="min-w-full divide-y divide-gray-200">
                                                    <thead className="bg-gray-50">
                                                        <tr>
                                                            <th
                                                                scope="col"
                                                                className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"
                                                            >
                                                                Resource Group
                                                            </th>
                                                            <th
                                                                scope="col"
                                                                className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"
                                                            >
                                                                Total Cost (€)
                                                            </th>
                                                        </tr>
                                                    </thead>
                                                    <tbody className="bg-white divide-y divide-gray-200">
                                                        {Array.from(
                                                            new Set(
                                                                Object.values(costData.services)
                                                                    .flatMap((service) => service.costs)
                                                                    .filter((item) => selectedSubscriptions.includes(item.subscriptionId))
                                                                    .map((item) => item.resourceGroup)
                                                                    .filter((rg) => rg)
                                                            )
                                                        ).map((rg) => {
                                                            const rgCost = Object.values(costData.services).reduce((sum, service) => {
                                                                const cost = service.costs
                                                                    .filter((item) => item.resourceGroup === rg && selectedSubscriptions.includes(item.subscriptionId))
                                                                    .reduce((total, item) => total + item.cost, 0);
                                                                return sum + cost;
                                                            }, 0);
                                                            return (
                                                                <tr key={rg}>
                                                                    <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-900">{rg}</td>
                                                                    <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                                                                        €{rgCost.toFixed(2)}
                                                                    </td>
                                                                </tr>
                                                            );
                                                        })}
                                                    </tbody>
                                                </table>
                                            </div>
                                        </div>
                                    )}
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        ReactDOM.render(
            <ErrorBoundary>
                <App />
            </ErrorBoundary>,
            document.getElementById("root")
        );
    </script>
</body>

</html>